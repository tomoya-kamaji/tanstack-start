# 病院向けレビュー機能 - 実装プラン

> 最終更新: 2024-12-23

## 全体進捗

```
[████████████░░░░░░░░] 60% (M1完了、M2完了、M3完了 / M4〜M5残)
```

| マイルストーン         | 状態    | 見積もり | 実績    |
| ---------------------- | ------- | -------- | ------- |
| M1: 基盤構築           | ✅ 完了 | 3時間    | 3時間   |
| M2: 病院管理機能       | ✅ 完了 | 3時間    | 2.5時間 |
| M3: 制作物公開機能     | ✅ 完了 | 3時間    | 3時間   |
| M4: レビュー画面       | ⏳ 待機 | 5時間    | -       |
| M5: フィードバック確認 | ⏳ 待機 | 1.5時間  | -       |

---

## 1. マイルストーン

### M1: 基盤構築（Firebase + DB）

**目的**: Firebase匿名認証とデータベーススキーマを構築する

| タスク | 内容                                                          | 見積もり |
| ------ | ------------------------------------------------------------- | -------- |
| T1-1   | Firebase プロジェクト設定（環境変数追加）                     | 30分     |
| T1-2   | Nuxt に Firebase SDK 導入                                     | 1時間    |
| T1-3   | Prisma スキーマ追加（Hospital, HospitalMember, StepFeedback） | 1時間    |
| T1-4   | マイグレーション実行・動作確認                                | 30分     |

**完了条件**: Firebase匿名認証が動作し、新テーブルが作成されている

---

### M2: 病院管理機能（Contrea側）

**目的**: 動画制作者が病院を登録・管理できるようにする

| タスク | 内容                    | 見積もり |
| ------ | ----------------------- | -------- |
| T2-1   | 病院CRUD API 作成       | 1時間    |
| T2-2   | 病院一覧・登録画面      | 1.5時間  |
| T2-3   | 招待URL表示・コピー機能 | 30分     |

**完了条件**: 病院の登録・一覧表示・招待URLコピーができる

---

### M3: 制作物公開機能

**目的**: 制作物を病院に紐づけて公開できるようにする

| タスク | 内容                                 | 見積もり |
| ------ | ------------------------------------ | -------- |
| T3-1   | 公開設定API作成                      | 30分     |
| T3-2   | ProductionCardにメニューボタン追加   | 1時間    |
| T3-3   | 公開設定モーダル作成                 | 1時間    |
| T3-4   | 制作物一覧APIに公開情報追加          | 30分     |

**UI方針**: カードに三点メニュー（⋯）を追加し、「公開設定」からモーダルで病院を選択

**完了条件**: 制作物一覧から公開設定モーダルを開いて病院に公開できる

---

### M4: 病院担当者向けレビュー画面

**目的**: 病院担当者がフィードバックを入力できる画面を構築する

| タスク | 内容                                           | 見積もり |
| ------ | ---------------------------------------------- | -------- |
| T4-1   | レビュー用レイアウト作成（ヘッダーなし簡易版） | 30分     |
| T4-2   | 名前入力画面（初回アクセス時）                 | 1時間    |
| T4-3   | 制作物一覧画面                                 | 1時間    |
| T4-4   | レビュー画面（ステップ一覧表示）               | 1.5時間  |
| T4-5   | フィードバック入力・保存機能                   | 1時間    |

**完了条件**: 病院担当者が招待URLからフィードバックを入力・保存できる

---

### M5: フィードバック確認機能（Contrea側）

**目的**: 動画制作者がフィードバックを確認できるようにする

| タスク | 内容                                         | 見積もり |
| ------ | -------------------------------------------- | -------- |
| T5-1   | フィードバック取得API                        | 30分     |
| T5-2   | フィードバック表示UI（制作物詳細画面に追加） | 1時間    |

**完了条件**: 動画制作者がフィードバックを確認できる

---

## 2. 依存関係

```
M1: 基盤構築
  │
  ├──▶ M2: 病院管理機能
  │      │
  │      └──▶ M3: 制作物公開機能
  │             │
  └─────────────┼──▶ M4: レビュー画面
                │      │
                └──────┴──▶ M5: フィードバック確認
```

**順序制約:**

- M1 → M2/M4: Firebase/DBが必要
- M2 → M3: 病院が存在しないと公開先を選べない
- M3 → M4: 公開された制作物がないとレビューできない
- M4 → M5: フィードバックがないと確認できない

---

## 3. 技術選定

### 3.1 Firebase設定

| 項目       | 選択                                       |
| ---------- | ------------------------------------------ |
| パッケージ | `firebase` (v10系)                         |
| 認証方式   | Anonymous Auth                             |
| 初期化場所 | Nuxt plugin (`plugins/firebase.client.ts`) |

### 3.2 画面構成

| パス                   | 用途                             | レイアウト     |
| ---------------------- | -------------------------------- | -------------- |
| `/hospitals`           | 病院管理（Contrea）              | default        |
| `/review/[hospitalId]` | 名前入力 / 制作物一覧 / レビュー | review（新規） |

### 3.3 API設計

| エンドポイント                              | メソッド       | 用途                            |
| ------------------------------------------- | -------------- | ------------------------------- |
| `/api/hospitals`                            | GET/POST       | 病院一覧取得/作成               |
| `/api/hospitals/[id]`                       | GET/PUT/DELETE | 病院詳細/更新/削除              |
| `/api/productions/[id]/publish`             | PATCH          | 公開設定（病院紐付け）          |
| `/api/review/[hospitalId]/members`          | POST           | 担当者登録                      |
| `/api/review/[hospitalId]/productions`      | GET            | 公開済み制作物一覧              |
| `/api/review/[hospitalId]/productions/[id]` | GET            | 制作物詳細（ステップ含む）      |
| `/api/review/[hospitalId]/feedback`         | POST/PUT       | フィードバック保存              |
| `/api/productions/[id]/feedback`            | GET            | フィードバック取得（Contrea用） |

---

## 4. リスク

| リスク                         | 影響                          | 対策                                           |
| ------------------------------ | ----------------------------- | ---------------------------------------------- |
| Firebase設定ミス               | 認証が動かない                | 最初にFirebaseだけで動作確認                   |
| hospitalIdがURLに露出          | URLを知っていればアクセス可能 | UUIDで推測困難、将来的にトークン方式に移行可能 |
| 同一人物が別ブラウザでアクセス | 別の担当者として登録される    | 許容（仕様として説明）                         |

---

## 5. 見積もり合計

| マイルストーン         | 見積もり     |
| ---------------------- | ------------ |
| M1: 基盤構築           | 3時間        |
| M2: 病院管理機能       | 3時間        |
| M3: 制作物公開機能     | 3時間        |
| M4: レビュー画面       | 5時間        |
| M5: フィードバック確認 | 1.5時間      |
| **合計**               | **15.5時間** |

---

## 6. 実装順序（推奨）

1. **M1** → Firebase + DB基盤を先に構築
2. **M2** → 病院管理（これがないと他が進まない）
3. **M4** → レビュー画面（メイン機能、並行してM3も可）
4. **M3** → 制作物公開（M4と並行可能）
5. **M5** → フィードバック確認（最後でOK）
