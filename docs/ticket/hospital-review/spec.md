# 病院向けレビュー機能 - 要件定義書

## 1. 概要

### 1.1 背景・目的

動画制作の完成物を病院担当者に確認してもらい、フィードバックを収集するためのWeb機能。

**現状の課題:**

- スプレッドシートでフィードバックを収集している
- システム（管理画面）を病院担当者にそのまま見せることはできない
- ID/パスワードの発行・管理は煩雑

**解決策:**

- 病院担当者向けの専用レビュー画面を提供
- Firebase匿名認証を使用し、ID/パスワード管理を不要に
- hospitalIdをそのままURLに使用してシンプルに

### 1.2 対象ユーザー

| ユーザー              | 説明                                     |
| --------------------- | ---------------------------------------- |
| 動画制作者（Contrea） | 病院を登録し、招待URLを送付する          |
| 病院担当者            | 制作物を閲覧し、フィードバックを入力する |

---

## 2. 機能要件

### 2.1 機能一覧

| #   | 機能名             | 利用者     | 説明                                       |
| --- | ------------------ | ---------- | ------------------------------------------ |
| F1  | 病院登録           | 動画制作者 | 新規病院を登録する                         |
| F2  | 招待URL表示        | 動画制作者 | 病院の招待URLを表示・コピーする            |
| F3  | 制作物公開設定     | 動画制作者 | 制作物を病院に公開する                     |
| F4  | 名前入力           | 病院担当者 | 初回アクセス時に名前を入力する             |
| F5  | 制作物一覧表示     | 病院担当者 | 公開された制作物の一覧を表示する           |
| F6  | レビュー画面表示   | 病院担当者 | 制作物のステップ一覧を表示する             |
| F7  | フィードバック入力 | 病院担当者 | 各ステップにフィードバックを入力・保存する |
| F8  | フィードバック確認 | 動画制作者 | 病院からのフィードバックを確認する         |

### 2.2 機能詳細

#### F1: 病院登録

**概要**: 新規病院をシステムに登録する

**入力項目:**
| 項目 | 必須 | 説明 |
|------|------|------|
| 病院名 | ✅ | 表示名 |
| メモ | - | 内部用メモ |

**出力:**

- 病院ID（UUID）が自動生成される
- 招待URLが自動的に確定する（`/review/[hospitalId]`）

---

#### F2: 招待URL表示

**概要**: 病院の招待URLを表示・コピーする

**URL形式:**

```
https://[ドメイン]/review/[hospitalId]
```

**機能:**

- URLをワンクリックでコピー
- 病院一覧から確認可能

---

#### F3: 制作物公開設定

**概要**: 制作物を特定の病院に公開する

**操作:**

1. 制作物一覧画面でカードの三点メニュー（⋯）をクリック
2. 「公開設定」を選択
3. モーダルで公開先病院を選択
4. 保存

**画面:**

```
カード表示:
┌─────────────────────────────┐
│ [サムネイル]          [⋯]  │ ← 三点メニュー
│                             │
│ 入院案内動画               │
│ 2024/12/24                 │
│ 🏥 ○○病院に公開中         │ ← 公開状態表示
│                [再編集]    │
└─────────────────────────────┘

メニュー:
  ├── 公開設定...
  └── (将来: 削除など)

公開設定モーダル:
┌─────────────────────────────────┐
│ 公開設定                     ✕ │
├─────────────────────────────────┤
│  公開先病院:                    │
│  ┌─────────────────────────┐   │
│  │ ○○総合病院           ▼ │   │
│  └─────────────────────────┘   │
│       [キャンセル] [保存]       │
└─────────────────────────────────┘
```

**制約:**

- 1つの制作物は1つの病院にのみ公開可能
- 公開解除も可能（「未公開」を選択）

---

#### F4: 名前入力

**概要**: 初回アクセス時に名前を入力してもらう

**画面:**

```
┌─────────────────────────────────────────┐
│  ○○病院 レビューシステム               │
├─────────────────────────────────────────┤
│                                         │
│  お名前を入力してください               │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │                                 │   │
│  └─────────────────────────────────┘   │
│                                         │
│           [ 開始する ]                  │
│                                         │
└─────────────────────────────────────────┘
```

**動作:**

- Firebase匿名認証を実行
- 名前とUID、病院IDを紐づけて保存
- 2回目以降は自動ログイン（名前入力スキップ）

---

#### F5: 制作物一覧表示

**概要**: 病院に公開された制作物の一覧を表示する

**表示項目:**
| 項目 | 説明 |
|------|------|
| 制作物名 | タイトル |
| 更新日時 | 最終更新日 |
| ステータス | レビュー済 / レビュー待 |

---

#### F6: レビュー画面表示

**概要**: 制作物のステップ一覧を表示する

**表示項目（ステップごと）:**
| 項目 | 説明 |
|------|------|
| ボード画像 | ステップのサムネイル |
| テキスト | ナレーション/テロップの内容 |
| フィードバック入力欄 | 自由入力テキストエリア |

---

#### F7: フィードバック入力

**概要**: 各ステップにフィードバックを入力・保存する

**機能:**

- ステップごとに自由入力テキスト
- 保存ボタンで一括保存
- 保存後も編集可能

---

#### F8: フィードバック確認

**概要**: 動画制作者が病院からのフィードバックを確認する

**表示項目:**
| 項目 | 説明 |
|------|------|
| 制作物名 | タイトル |
| 担当者名 | フィードバックした人の名前 |
| ステップ番号 | 対象ステップ |
| フィードバック内容 | テキスト |
| 送信日時 | フィードバック日時 |

---

## 3. 画面フロー

### 3.1 病院登録フロー（動画制作者）

```
動画制作者: 「○○病院を登録」
    ↓
システム: 病院を作成、招待URL（= /review/[hospitalId]）を表示
    ↓
動画制作者: URLをメール等で病院に送付
```

### 3.2 制作物公開フロー（動画制作者）

```
動画制作者: 制作物一覧画面を開く
    ↓
動画制作者: カードの三点メニュー（⋯）をクリック
    ↓
動画制作者: 「公開設定」を選択
    ↓
システム: 公開設定モーダルを表示（病院一覧をセレクトボックスで表示）
    ↓
動画制作者: 公開先病院を選択して保存
    ↓
システム: 制作物を病院に紐づけて公開、カードに公開状態を表示
```

### 3.3 病院担当者の画面フロー

```
招待URLをクリック
    ↓
名前入力画面（初回のみ）
    ↓ (自動ログイン)
制作物一覧画面
    ↓ (制作物を選択)
レビュー画面（ステップ一覧 + フィードバック入力）
```

### 3.4 フィードバック確認フロー（動画制作者）

```
動画制作者: フィードバック一覧を確認
    ↓
動画制作者: 制作物を修正・再公開
```

---

## 4. データモデル

### 4.1 テーブル構成

```
Hospital（病院）
├── id: UUID (PK)
├── name: String         # 病院名
├── memo: String?        # 内部メモ
├── createdAt: DateTime
└── updatedAt: DateTime

HospitalMember（病院担当者）
├── id: UUID (PK)
├── hospitalId: UUID (FK → Hospital)
├── firebaseUid: String  # Firebase匿名認証のUID
├── name: String         # 担当者名（自由入力）
├── createdAt: DateTime
└── updatedAt: DateTime

VideoProduction（制作物）※既存テーブル拡張
├── ... 既存カラム ...
└── publishedHospitalId: UUID? (FK → Hospital)  # 公開先病院

StepFeedback（ステップフィードバック）
├── id: UUID (PK)
├── videoProductionId: UUID (FK → VideoProduction)
├── stepIndex: Int       # ステップ番号
├── hospitalMemberId: UUID (FK → HospitalMember)
├── content: String      # フィードバック内容
├── createdAt: DateTime
└── updatedAt: DateTime
```

### 4.2 ER図

```
┌──────────────┐     1:N     ┌─────────────────┐
│   Hospital   │────────────▶│ HospitalMember  │
└──────────────┘             └─────────────────┘
       │                            │
       │ 1:N                        │ 1:N
       ▼                            ▼
┌──────────────────┐         ┌──────────────────┐
│ VideoProduction  │◀────────│  StepFeedback    │
└──────────────────┘         └──────────────────┘
```

---

## 5. 認証設計

### 5.1 Firebase匿名認証

**選択理由:**

- ID/パスワード管理が不要
- 導入が簡単
- 無料枠で十分

**動作:**

1. 招待URLアクセス時に`signInAnonymously()`実行
2. ブラウザにUIDが保存される（IndexedDB）
3. 同じブラウザなら次回から自動ログイン
4. 別ブラウザ/端末は新しいUIDが発行される

### 5.2 アクセス制御

| エンドポイント         | 認証             | 認可                             |
| ---------------------- | ---------------- | -------------------------------- |
| `/review/[hospitalId]` | Firebase匿名認証 | hospitalIdが存在すればアクセス可 |
| 制作物一覧API          | Firebase匿名認証 | UIDに紐づく病院の制作物のみ      |
| フィードバック保存API  | Firebase匿名認証 | UIDに紐づく病院の制作物のみ      |

---

## 6. 非機能要件

### 6.1 パフォーマンス

- レビュー画面の初回表示: 3秒以内

### 6.2 セキュリティ

- hospitalIdはUUID形式（推測困難）
- Firebase認証トークンをAPI呼び出しに使用
- 病院担当者は自分が属する病院の制作物のみアクセス可能

### 6.3 ブラウザサポート

- Chrome / Edge / Safari / Firefox の最新版

---

## 7. スコープ外（将来対応）

| 機能               | 説明                          |
| ------------------ | ----------------------------- |
| フィードバック通知 | メール/Slack通知              |
| URL有効期限        | 招待URLの期限設定             |
| 動画プレビュー     | 完成動画の再生                |
| 履歴管理           | フィードバックの変更履歴      |
| URL再発行          | hospitalIdを変更してURL無効化 |

---

## 8. 受け入れ基準

- [ ] 動画制作者が病院を登録できる
- [ ] 動画制作者が招待URLをコピーできる
- [ ] 動画制作者が制作物を病院に公開できる
- [ ] 病院担当者が招待URLからアクセスし、名前を入力できる
- [ ] 病院担当者が制作物一覧を閲覧できる
- [ ] 病院担当者がレビュー画面でステップを確認できる
- [ ] 病院担当者がフィードバックを入力・保存できる
- [ ] 動画制作者がフィードバックを確認できる
